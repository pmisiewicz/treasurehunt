(function(){"use strict";const $=Math.sqrt(3),ot=.5*($-1),W=(3-$)/6,rt=1/3,G=1/6,Y=o=>Math.floor(o)|0,tt=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]),J=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);function st(o=Math.random){const t=et(o),e=new Float64Array(t).map(s=>tt[s%12*2]),n=new Float64Array(t).map(s=>tt[s%12*2+1]);return function(w,c){let k=0,r=0,y=0;const p=(w+c)*ot,x=Y(w+p),v=Y(c+p),C=(x+v)*W,R=x-C,E=v-C,D=w-R,h=c-E;let L,A;D>h?(L=1,A=0):(L=0,A=1);const O=D-L+W,u=h-A+W,l=D-1+2*W,d=h-1+2*W,g=x&255,M=v&255;let q=.5-D*D-h*h;if(q>=0){const i=g+t[M],_=e[i],P=n[i];q*=q,k=q*q*(_*D+P*h)}let m=.5-O*O-u*u;if(m>=0){const i=g+L+t[M+A],_=e[i],P=n[i];m*=m,r=m*m*(_*O+P*u)}let f=.5-l*l-d*d;if(f>=0){const i=g+1+t[M+1],_=e[i],P=n[i];f*=f,y=f*f*(_*l+P*d)}return 70*(k+r+y)}}function it(o=Math.random){const t=et(o),e=new Float64Array(t).map(w=>J[w%12*3]),n=new Float64Array(t).map(w=>J[w%12*3+1]),s=new Float64Array(t).map(w=>J[w%12*3+2]);return function(c,k,r){let y,p,x,v;const C=(c+k+r)*rt,R=Y(c+C),E=Y(k+C),D=Y(r+C),h=(R+E+D)*G,L=R-h,A=E-h,O=D-h,u=c-L,l=k-A,d=r-O;let g,M,q,m,f,i;u>=l?l>=d?(g=1,M=0,q=0,m=1,f=1,i=0):u>=d?(g=1,M=0,q=0,m=1,f=0,i=1):(g=0,M=0,q=1,m=1,f=0,i=1):l<d?(g=0,M=0,q=1,m=0,f=1,i=1):u<d?(g=0,M=1,q=0,m=0,f=1,i=1):(g=0,M=1,q=0,m=1,f=1,i=0);const _=u-g+G,P=l-M+G,X=d-q+G,B=u-m+2*G,H=l-f+2*G,j=d-i+2*G,z=u-1+3*G,N=l-1+3*G,I=d-1+3*G,F=R&255,a=E&255,U=D&255;let V=.6-u*u-l*l-d*d;if(V<0)y=0;else{const b=F+t[a+t[U]];V*=V,y=V*V*(e[b]*u+n[b]*l+s[b]*d)}let S=.6-_*_-P*P-X*X;if(S<0)p=0;else{const b=F+g+t[a+M+t[U+q]];S*=S,p=S*S*(e[b]*_+n[b]*P+s[b]*X)}let T=.6-B*B-H*H-j*j;if(T<0)x=0;else{const b=F+m+t[a+f+t[U+i]];T*=T,x=T*T*(e[b]*B+n[b]*H+s[b]*j)}let Q=.6-z*z-N*N-I*I;if(Q<0)v=0;else{const b=F+1+t[a+1+t[U+1]];Q*=Q,v=Q*Q*(e[b]*z+n[b]*N+s[b]*I)}return 32*(y+p+x+v)}}function et(o){const e=new Uint8Array(512);for(let n=0;n<512/2;n++)e[n]=n;for(let n=0;n<512/2-1;n++){const s=n+~~(o()*(256-n)),w=e[n];e[n]=e[s],e[s]=w}for(let n=256;n<512;n++)e[n]=e[n-256];return e}function at(o){return function(){let t=o+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function nt(o){let t=2166136261;for(let e=0;e<o.length;e++)t^=o.charCodeAt(e),t=Math.imul(t,16777619)>>>0;return t>>>0}function ct(){try{if(typeof window<"u"){const t=new URLSearchParams(window.location.search).get("seed");if(t!=null){const n=Number(t);return Number.isFinite(n)?n>>>0:nt(t)}const e=window.__RANDOM_SEED;if(e!=null)return typeof e=="number"?e>>>0:nt(String(e))}}catch(o){console.log(o)}return null}function lt(){const o=ct();return o!=null?o>>>0:Math.floor(Math.random()*4294967295)>>>0}class ht{simplex2D;simplex3D;rng;constructor(t){this.rng=at(t),this.simplex2D=st(this.rng),this.simplex3D=it(this.rng)}random(){return this.rng()}}lt();function ft(o,t,e,n,s,w,c,k){const r=w,y=k||{islandRadiusFactor:.4,transitionZoneFactor:.15,detailStartHeight:0,detailFullHeightFactor:.6,oceanDropMultiplier:1.5,underwaterEdgeThresholdFactor:.5},p=Math.sqrt(o*o+t*t),x=s*y.islandRadiusFactor,v=s*y.transitionZoneFactor;let C=1;if(p>x){const u=p-x,l=Math.min(u/v,1);C=1-l*l*(3-2*l)}let R=0;R+=c.simplex2D(o*e*r.veryLowFreq.freq+r.veryLowFreq.phaseX,t*e*r.veryLowFreq.freq+r.veryLowFreq.phaseZ)*n*r.veryLowFreq.weight,R+=c.simplex2D(o*e*r.lowFreq.freq+r.lowFreq.phaseX,t*e*r.lowFreq.freq+r.lowFreq.phaseZ)*n*r.lowFreq.weight;const E=y.detailStartHeight,D=E+n*y.detailFullHeightFactor;let h=(R-E)/(D-E);h=Math.max(0,Math.min(1,h));const L=h*h*(3-2*h);let A=0;A+=c.simplex2D(o*e*r.midFreq.freq+r.midFreq.phaseX,t*e*r.midFreq.freq+r.midFreq.phaseZ)*n*r.midFreq.weight,A+=c.simplex2D(o*e*r.highFreq.freq+r.highFreq.phaseX,t*e*r.highFreq.freq+r.highFreq.phaseZ)*n*r.highFreq.weight,A+=c.simplex2D(o*e*r.veryHighFreq.freq+r.veryHighFreq.phaseX,t*e*r.veryHighFreq.freq+r.veryHighFreq.phaseZ)*n*r.veryHighFreq.weight;let O=R+A*L;return O*=C,O-=(1-C)*(n*y.oceanDropMultiplier),O=Math.max(-n*y.oceanDropMultiplier,Math.min(n,O)),p>x+v*y.underwaterEdgeThresholdFactor&&(O=Math.min(O,-3)),O}function K(o){return[(o>>16&255)/255,(o>>8&255)/255,(o&255)/255]}function Z(o,t,e){return[o[0]+(t[0]-o[0])*e,o[1]+(t[1]-o[1])*e,o[2]+(t[2]-o[2])*e]}function ut(o){const{tx:t,tz:e,segments:n,tileSize:s,terrainParams:w,biomeColors:c,biomeHeightStops:k,terrainHeight:r,terrainScale:y,waterLevel:p,worldSize:x,seed:v,falloff:C}=o,R=new ht(v),E=n+1,D=E*E,h=new Float32Array(D),L=new Float32Array(D*3),A=t*s-s/2,O=e*s-s/2,u=K(c.submerged),l=K(c.low),d=K(c.mid),g=K(c.high),M=K(c.rock),q=K(c.peak),m=p,f=p+r*k.lowStop,i=p+r*k.midStop,_=p+r*k.highStop,P=p+r*k.rockStop,X=p+r*k.peakStop,B=r;let H=0;for(let j=0;j<=n;j++)for(let z=0;z<=n;z++){const N=A+z/n*s,I=O+j/n*s;let F=ft(N,I,y,r,x,w,R,C);h[H]=F;let a=[0,0,0];const U=R.simplex2D(N*.3,I*.3)*.5+.5,V=R.simplex2D(N*.5,I*.5)*.5+.5;if(F<m)a=u;else if(F<f){const S=Math.max(0,Math.min(1,(F-m)/(f-m)));a=Z(u,l,S)}else if(F<i){const S=Math.max(0,Math.min(1,(F-f)/(i-f)));a=Z(l,d,S)}else if(F<_){const S=Math.max(0,Math.min(1,(F-i)/(_-i)));a=Z(d,g,S)}else if(F<P){const S=Math.max(0,Math.min(1,(F-_)/(P-_))),T=Z(M,g,U*.3);a=Z(g,T,S)}else if(F<X)a=Z(M,g,U*.5);else{const S=Math.max(0,Math.min(1,(F-X)/(B-X)));a=Z(M,q,S);const T=V*.08;a[0]=Math.min(1,a[0]+T),a[1]=Math.min(1,a[1]+T),a[2]=Math.min(1,a[2]+T)}L[H*3]=a[0],L[H*3+1]=a[1],L[H*3+2]=a[2],H++}return{heights:h,colors:L}}self.onmessage=o=>{const t=o.data;if(t.type==="generate"){const e=ut(t);self.postMessage({type:"chunk-ready",tx:t.tx,tz:t.tz,heights:e.heights,colors:e.colors},[e.heights.buffer,e.colors.buffer])}}})();
